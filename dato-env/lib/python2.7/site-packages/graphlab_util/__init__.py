'''
Copyright (C) 2015 Dato, Inc.
All rights reserved.

This software may be modified and distributed under the terms
of the BSD license. See the DATO-PYTHON-LICENSE file for details.
'''
# 1st set up logging
import logging
from logging.handlers import TimedRotatingFileHandler
import logging.config
import time as _time
import tempfile as _tempfile
import os as _os
from Queue import Queue as queue
from queue_channel import QueueHandler, MutableQueueListener

# overuse the same 'graphlab' logger so we have one logging config
logger = logging.getLogger('graphlab')
client_log_file = _os.path.join(_tempfile.gettempdir(), ('graphlab_client_%d.log' % _time.time()))

logging.config.dictConfig({
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'standard': {
            'format': '%(asctime)s [%(levelname)s] %(name)s: %(message)s'
        },
        'brief': {
            'format': '[%(levelname)s] %(message)s'
        }
    },
    'handlers': {
        'default': {
            'class': 'logging.StreamHandler',
            'formatter': 'brief'
        },
        'file': {
            'class':'logging.FileHandler',
            'formatter':'standard',
            'filename':client_log_file,
            'encoding': 'UTF-8',
            'delay': 'False',
        }
    },
    'loggers': {
        '': {
            'handlers': ['default', 'file'],
            'propagate': 'True'
        }
    }
})

# Set module specific log levels
logging.getLogger('librato').setLevel(logging.CRITICAL)
logging.getLogger('requests').setLevel(logging.CRITICAL)
logging.getLogger('graphlab').setLevel(logging.INFO)
logging.getLogger(__name__).setLevel(logging.INFO)

#amend the logging configuration with a handler streaming to a message queue

q = queue(-1)
ql = MutableQueueListener(q)

qh = QueueHandler(q)
logging.root.addHandler(qh)

ql.start()

def stop_queue_listener():
    ql.stop()

def _attach_log_handler(handler):
    ql.addHandler(handler)

def _detach_log_handler(handler):
    ql.removeHandler(handler)
